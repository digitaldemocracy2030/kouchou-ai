name: Azure Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AZURE_ACR_NAME: ${{ vars.AZURE_ACR_NAME }}
  AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
  AZURE_LOCATION: ${{ vars.AZURE_LOCATION }}
  AZURE_CONTAINER_ENV: ${{ vars.AZURE_CONTAINER_ENV }}
  AZURE_BLOB_STORAGE_ACCOUNT_NAME: ${{ vars.AZURE_BLOB_STORAGE_ACCOUNT_NAME }}
  AZURE_BLOB_STORAGE_CONTAINER_NAME: ${{ vars.AZURE_BLOB_STORAGE_CONTAINER_NAME }}
  ENVIRONMENT: ${{ vars.ENVIRONMENT }}
  BASIC_AUTH_USERNAME: ${{ vars.BASIC_AUTH_USERNAME }}
  PUBLIC_API_KEY: ${{ secrets.PUBLIC_API_KEY }}
  ADMIN_API_KEY: ${{ secrets.ADMIN_API_KEY }}
  BASIC_AUTH_PASSWORD: ${{ secrets.BASIC_AUTH_PASSWORD }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  REVALIDATE_SECRET: ${{ secrets.REVALIDATE_SECRET }}

jobs:
  deploy:
    if: github.repository == 'digitaldemocracy2030/kouchou-ai'
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure CLI ログイン
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Docker ログイン (ACR)
        run: |
          set -euo pipefail
          az acr login --name ${{ env.AZURE_ACR_NAME }}

      - name: Python環境のセットアップ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Python依存関係のインストール
        run: |
          python -m pip install --upgrade pip
          pip install requests python-dotenv

      - name: 環境変数ファイルの準備
        run: |
          # .env.azureファイルの作成（Makefileで使用）
          cat > .env.azure << EOF
          AZURE_RESOURCE_GROUP=${{ env.AZURE_RESOURCE_GROUP }}
          AZURE_LOCATION=${{ env.AZURE_LOCATION }}
          AZURE_ACR_NAME=${{ env.AZURE_ACR_NAME }}
          AZURE_CONTAINER_ENV=${{ env.AZURE_CONTAINER_ENV }}
          AZURE_BLOB_STORAGE_ACCOUNT_NAME=${{ env.AZURE_BLOB_STORAGE_ACCOUNT_NAME }}
          AZURE_BLOB_STORAGE_CONTAINER_NAME=${{ env.AZURE_BLOB_STORAGE_CONTAINER_NAME }}
          EOF

      - name: ドメイン情報の準備
        run: |
          # ドメイン情報を直接環境変数に設定
          echo "API_DOMAIN=$(az containerapp show --name api \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)" >> $GITHUB_ENV
          echo "PUBLIC_VIEWER_DOMAIN=$(az containerapp show --name public-viewer \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)" >> $GITHUB_ENV
          echo "ADMIN_DOMAIN=$(az containerapp show --name admin \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)" >> $GITHUB_ENV
          echo "STATIC_SITE_BUILDER_DOMAIN=$(az containerapp show --name static-site-builder \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)" >> $GITHUB_ENV

      - name: Azure環境のデプロイ
        run: |
          set -euo pipefail
          # ルートコンテキスト化に伴い .env.azure を一時退避
          ENV_AZURE_TMP="${RUNNER_TEMP}/.env.azure"
          if [ -f .env.azure ]; then
            mv .env.azure "$ENV_AZURE_TMP"
          fi

          # レポートのバックアップを取得
          if [ -n "$API_DOMAIN" ]; then
            echo "レポートのバックアップを取得中..."
            python3 tools/scripts/fetch_reports.py --api-url https://$API_DOMAIN
          else
            echo "❌ レポートのバックアップが取得できませんでした"
            exit 1
          fi

          # 全イメージを並列ビルド
          build_pids=()
          docker build --platform linux/amd64 \
            -f ./apps/api/Dockerfile \
            -t ${AZURE_ACR_NAME}.azurecr.io/api:latest \
            . & build_pids+=("$!")
          docker build --platform linux/amd64 \
            -f ./apps/public-viewer/Dockerfile \
            --build-arg NEXT_PUBLIC_API_BASEPATH="https://${API_DOMAIN}" \
            --build-arg NEXT_PUBLIC_PUBLIC_API_KEY="${PUBLIC_API_KEY}" \
            --build-arg API_BASEPATH="https://${API_DOMAIN}" \
            -t ${AZURE_ACR_NAME}.azurecr.io/public-viewer:latest \
            . & build_pids+=("$!")
          docker build --platform linux/amd64 \
            -f ./apps/admin/Dockerfile \
            --build-arg NEXT_PUBLIC_CLIENT_BASEPATH="https://${PUBLIC_VIEWER_DOMAIN}" \
            --build-arg NEXT_PUBLIC_ADMIN_API_KEY="${ADMIN_API_KEY}" \
            --build-arg NEXT_PUBLIC_API_BASEPATH="https://${API_DOMAIN}" \
            --build-arg CLIENT_STATIC_BUILD_BASEPATH="https://${STATIC_SITE_BUILDER_DOMAIN}" \
            --build-arg BASIC_AUTH_USERNAME="${BASIC_AUTH_USERNAME}" \
            --build-arg BASIC_AUTH_PASSWORD="${BASIC_AUTH_PASSWORD}" \
            --build-arg API_BASEPATH="https://${API_DOMAIN}" \
            -t ${AZURE_ACR_NAME}.azurecr.io/admin:latest \
            . & build_pids+=("$!")
          docker build --platform linux/amd64 \
            --build-arg NEXT_PUBLIC_API_BASEPATH="https://${API_DOMAIN}" \
            --build-arg NEXT_PUBLIC_PUBLIC_API_KEY="${PUBLIC_API_KEY}" \
            --build-arg API_BASEPATH="https://${API_DOMAIN}" \
            -f ./apps/static-site-builder/Dockerfile \
            -t ${AZURE_ACR_NAME}.azurecr.io/static-site-builder:latest \
            . & build_pids+=("$!")

          # 全ビルドの完了を待機 (失敗を確実に検知)
          for pid in "${build_pids[@]}"; do
            wait "$pid"
          done

          # イメージを並列プッシュ
          push_pids=()
          docker push ${AZURE_ACR_NAME}.azurecr.io/api:latest & push_pids+=("$!")
          docker push ${AZURE_ACR_NAME}.azurecr.io/public-viewer:latest & push_pids+=("$!")
          docker push ${AZURE_ACR_NAME}.azurecr.io/admin:latest & push_pids+=("$!")
          docker push ${AZURE_ACR_NAME}.azurecr.io/static-site-builder:latest & push_pids+=("$!")

          # 全プッシュの完了を待機 (失敗を確実に検知)
          for pid in "${push_pids[@]}"; do
            wait "$pid"
          done

          # make 用に .env.azure を復元
          if [ -f "$ENV_AZURE_TMP" ]; then
            mv "$ENV_AZURE_TMP" .env.azure
          fi

          # ヘルスプローブとポリシーの適用
          make azure-apply-policies || echo "ポリシー適用をスキップ"

      - name: 全コンテナのシークレット登録
        run: |
          # APIコンテナのシークレット登録
          az containerapp secret set \
            --name api --resource-group ${AZURE_RESOURCE_GROUP} \
            --secrets \
              openai-api-key=${OPENAI_API_KEY} \
              public-api-key=${PUBLIC_API_KEY} \
              admin-api-key=${ADMIN_API_KEY} \
              revalidate-secret=${REVALIDATE_SECRET} \
              azure-blob-storage-account-name=${AZURE_BLOB_STORAGE_ACCOUNT_NAME} \
              azure-blob-storage-container-name=${AZURE_BLOB_STORAGE_CONTAINER_NAME}

          # Public-viewerコンテナのシークレット登録
          az containerapp secret set \
            --name public-viewer --resource-group ${AZURE_RESOURCE_GROUP} \
            --secrets \
              public-api-key=${PUBLIC_API_KEY} \
              revalidate-secret=${REVALIDATE_SECRET}

          # Adminコンテナのシークレット登録
          az containerapp secret set \
            --name admin --resource-group ${AZURE_RESOURCE_GROUP} \
            --secrets \
              admin-api-key=${ADMIN_API_KEY} \
              basic-auth-username=${BASIC_AUTH_USERNAME} \
              basic-auth-password=${BASIC_AUTH_PASSWORD}

          # Static-site-builderコンテナのシークレット登録
          az containerapp secret set \
            --name static-site-builder --resource-group ${AZURE_RESOURCE_GROUP} \
            --secrets \
              public-api-key=${PUBLIC_API_KEY}

      - name: コンテナ更新（イメージと環境変数を同時設定）
        run: |
          set -euo pipefail
          # 全コンテナのイメージと環境変数を同時に更新
          update_pids=()

          # APIコンテナの更新（イメージ + 環境変数）
          az containerapp update --name api --resource-group ${AZURE_RESOURCE_GROUP} \
            --image ${AZURE_ACR_NAME}.azurecr.io/api:latest \
            --set-env-vars \
              "OPENAI_API_KEY=secretref:openai-api-key" \
              "PUBLIC_API_KEY=secretref:public-api-key" \
              "ADMIN_API_KEY=secretref:admin-api-key" \
              "LOG_LEVEL=info" \
              "AZURE_BLOB_STORAGE_ACCOUNT_NAME=secretref:azure-blob-storage-account-name" \
              "AZURE_BLOB_STORAGE_CONTAINER_NAME=secretref:azure-blob-storage-container-name" \
              "STORAGE_TYPE=azure_blob" \
              "REVALIDATE_URL=https://${PUBLIC_VIEWER_DOMAIN}/api/revalidate" \
              "REVALIDATE_SECRET=secretref:revalidate-secret" \
              "ENVIRONMENT=${ENVIRONMENT}" & update_pids+=("$!")

          # Public-viewerコンテナの更新（イメージ + 環境変数）
          az containerapp update --name public-viewer --resource-group ${AZURE_RESOURCE_GROUP} \
            --image ${AZURE_ACR_NAME}.azurecr.io/public-viewer:latest \
            --set-env-vars \
              "NEXT_PUBLIC_API_BASEPATH=https://${API_DOMAIN}" \
              "API_BASEPATH=https://${API_DOMAIN}" \
              "NEXT_PUBLIC_PUBLIC_API_KEY=secretref:public-api-key" \
              "REVALIDATE_SECRET=secretref:revalidate-secret" & update_pids+=("$!")

          # Adminコンテナの更新（イメージ + 環境変数）
          az containerapp update --name admin --resource-group ${AZURE_RESOURCE_GROUP} \
            --image ${AZURE_ACR_NAME}.azurecr.io/admin:latest \
            --set-env-vars \
              "NEXT_PUBLIC_API_BASEPATH=https://${API_DOMAIN}" \
              "API_BASEPATH=https://${API_DOMAIN}" \
              "NEXT_PUBLIC_ADMIN_API_KEY=secretref:admin-api-key" \
              "CLIENT_STATIC_BUILD_BASEPATH=https://${STATIC_SITE_BUILDER_DOMAIN}" \
              "BASIC_AUTH_USERNAME=secretref:basic-auth-username" \
              "BASIC_AUTH_PASSWORD=secretref:basic-auth-password" & update_pids+=("$!")

          # Static-site-builderコンテナの更新（イメージ + 環境変数）
          az containerapp update --name static-site-builder --resource-group ${AZURE_RESOURCE_GROUP} \
            --image ${AZURE_ACR_NAME}.azurecr.io/static-site-builder:latest \
            --set-env-vars \
              "NEXT_PUBLIC_API_BASEPATH=https://${API_DOMAIN}" \
              "NEXT_PUBLIC_PUBLIC_API_KEY=secretref:public-api-key" & update_pids+=("$!")

          # 全更新の完了を待機
          for pid in "${update_pids[@]}"; do
            wait "$pid"
          done

      - name: デプロイ確認
        run: |
          if [ -z "$API_DOMAIN" ]; then
            echo "❌ APIドメインが取得できませんでした"
            exit 1
          fi
          if [ -z "$PUBLIC_VIEWER_DOMAIN" ]; then
            echo "❌ Public-viewerドメインが取得できませんでした"
            exit 1
          fi

          # リトライ付きヘルスチェック
          RETRY_COUNT=6
          RETRY_INTERVAL=20

          for i in $(seq 1 $RETRY_COUNT); do
            echo "ヘルスチェック試行 $i/$RETRY_COUNT..."
            api_ok=0
            viewer_ok=0
            if curl -f "https://$API_DOMAIN/" --max-time 10 > /dev/null 2>&1; then
              api_ok=1
            fi
            if curl -f "https://$PUBLIC_VIEWER_DOMAIN/" --max-time 10 > /dev/null 2>&1; then
              viewer_ok=1
            fi
            if [ "$api_ok" -eq 1 ] && [ "$viewer_ok" -eq 1 ]; then
              echo "✅ デプロイ成功: https://$API_DOMAIN"
              echo "✅ デプロイ成功: https://$PUBLIC_VIEWER_DOMAIN"
              exit 0
            fi
            [ $i -lt $RETRY_COUNT ] && sleep $RETRY_INTERVAL
          done

          echo "❌ ヘルスチェック失敗"
          exit 1
