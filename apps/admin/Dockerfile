FROM node:22-alpine AS builder

WORKDIR /repo
RUN corepack enable

ARG NEXT_PUBLIC_CLIENT_BASEPATH
ARG NEXT_PUBLIC_ADMIN_API_KEY
ARG NEXT_PUBLIC_API_BASEPATH
ARG API_BASEPATH
ARG CLIENT_STATIC_BUILD_BASEPATH

ENV NEXT_PUBLIC_CLIENT_BASEPATH=${NEXT_PUBLIC_CLIENT_BASEPATH}
ENV NEXT_PUBLIC_ADMIN_API_KEY=${NEXT_PUBLIC_ADMIN_API_KEY}
ENV NEXT_PUBLIC_API_BASEPATH=${NEXT_PUBLIC_API_BASEPATH}
ENV CLIENT_STATIC_BUILD_BASEPATH=${CLIENT_STATIC_BUILD_BASEPATH}

COPY package.json pnpm-lock.yaml pnpm-workspace.yaml .npmrc ./
COPY packages/report-schema/package.json packages/report-schema/
COPY apps/admin/package.json apps/admin/
RUN pnpm install --frozen-lockfile

COPY packages/report-schema packages/report-schema
COPY apps/admin apps/admin

ENV NEXT_DISABLE_FETCH_DURING_BUILD=true

RUN pnpm --filter @kouchou-ai/report-schema build
RUN pnpm --filter @kouchou-ai/admin build

# 本番環境用イメージ
FROM node:22-alpine AS runner

WORKDIR /repo

ARG NEXT_PUBLIC_CLIENT_BASEPATH
ARG NEXT_PUBLIC_ADMIN_API_KEY
ARG NEXT_PUBLIC_API_BASEPATH
ARG API_BASEPATH
ARG CLIENT_STATIC_BUILD_BASEPATH

ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1

ENV NEXT_PUBLIC_CLIENT_BASEPATH=${NEXT_PUBLIC_CLIENT_BASEPATH}
ENV NEXT_PUBLIC_ADMIN_API_KEY=${NEXT_PUBLIC_ADMIN_API_KEY}
ENV NEXT_PUBLIC_API_BASEPATH=${NEXT_PUBLIC_API_BASEPATH}
ENV API_BASEPATH=${API_BASEPATH}
ENV CLIENT_STATIC_BUILD_BASEPATH=${CLIENT_STATIC_BUILD_BASEPATH}

COPY --from=builder /repo /repo

WORKDIR /repo/apps/admin
EXPOSE 4000
CMD ["npm", "start"]
